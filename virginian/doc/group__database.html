<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Virginian: Database File functions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Virginian</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Database File functions</div>  </div>
</div>
<div class="contents">
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__database.html#gaa6d6a3af446d22e836e0acc488db0348">virg_db_alloc</a> (<a class="el" href="structvirginian.html">virginian</a> *v, <a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> **<a class="el" href="vm__gpu_8cu.html#a98365893b0ed61f342c55a901d47b738">meta</a>, int id)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Allocate a tablet slot and return a pointer to it.  <a href="#gaa6d6a3af446d22e836e0acc488db0348"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__database.html#ga7a90f2b2186befe31067d4c13d3fa168">virg_db_clear</a> (<a class="el" href="structvirginian.html">virginian</a> *v, unsigned slot)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Clear out a certain tablet slot.  <a href="#ga7a90f2b2186befe31067d4c13d3fa168"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__database.html#ga8e2d3e3bf58554a5c2b58372c2211b66">virg_db_close</a> (<a class="el" href="structvirginian.html">virginian</a> *v)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Close the currently opened database.  <a href="#ga8e2d3e3bf58554a5c2b58372c2211b66"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__database.html#ga1d9e0bce415badbfb3fc06c0021d9de4">virg_db_create</a> (<a class="el" href="structvirginian.html">virginian</a> *v, const char *file)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Create and initialize a new database.  <a href="#ga1d9e0bce415badbfb3fc06c0021d9de4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__database.html#ga82086192c59cb1cb6dce14cbccdc4554">virg_db_findslot</a> (<a class="el" href="structvirginian.html">virginian</a> *v, unsigned *slot_)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Find an empty or unlocked tablet slot.  <a href="#ga82086192c59cb1cb6dce14cbccdc4554"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__database.html#ga45ebb12f5cd1cb668f06dcc64fd815a0">virg_db_load</a> (<a class="el" href="structvirginian.html">virginian</a> *v, unsigned tablet_id, <a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> **tab)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Load a tablet into a slot based on its ID and return a pointer.  <a href="#ga45ebb12f5cd1cb668f06dcc64fd815a0"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__database.html#ga78584f2bb7ca78e1cb87378929ce40f2">virg_db_loadnext</a> (<a class="el" href="structvirginian.html">virginian</a> *v, <a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> **tab)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Advance a tablet pointer to the next tablet in its string of tablets.  <a href="#ga78584f2bb7ca78e1cb87378929ce40f2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__database.html#gabbd5a202240db94bc243bab127c8157d">virg_db_open</a> (<a class="el" href="structvirginian.html">virginian</a> *v, const char *file)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Open an existing database file.  <a href="#gabbd5a202240db94bc243bab127c8157d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__database.html#gabba43a66f14c5ad7172401aa0005261f">virg_db_write</a> (<a class="el" href="structvirginian.html">virginian</a> *v, unsigned slot)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Write the tablet in a tablet slot to disk.  <a href="#gabba43a66f14c5ad7172401aa0005261f"></a><br/></td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="gaa6d6a3af446d22e836e0acc488db0348"></a><!-- doxytag: member="alloc.c::virg_db_alloc" ref="gaa6d6a3af446d22e836e0acc488db0348" args="(virginian *v, virg_tablet_meta **meta, int id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_db_alloc </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> **&#160;</td>
          <td class="paramname"><em>meta</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Allocate a tablet slot and return a pointer to it. </p>
<p>Find a free main-memory tablet slot using the <a class="el" href="group__database.html#ga82086192c59cb1cb6dce14cbccdc4554" title="Find an empty or unlocked tablet slot.">virg_db_findslot()</a> function, assign the passed ID to this tablet slot, and return a pointer to the slot through the 2nd argument. This function is called whenever a data or result tablet needs to be placed in memory.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">meta</td><td>Pointer to a pointer to a tablet, set during allocation </td></tr>
    <tr><td class="paramname">id</td><td>ID of the tablet for which a slot is being allocated </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="alloc_8c_source.html#l00018">18</a> of file <a class="el" href="alloc_8c_source.html">alloc.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="comment">// lock tablet slots</span>
        pthread_mutex_lock(&amp;v-&gt;<a class="code" href="structvirginian.html#a26ed4b0163e1b8a4ac20898715519588" title="mutex for multi-core manipulation of the tablet slots">slot_lock</a>);

        <span class="keywordtype">unsigned</span> slot;

        <span class="comment">// locate empty tablet slot</span>
        <a class="code" href="group__database.html#ga82086192c59cb1cb6dce14cbccdc4554" title="Find an empty or unlocked tablet slot.">virg_db_findslot</a>(v, &amp;slot);

        <span class="comment">// set id of this tablet slot, and return a ptr to it</span>
        meta[0] = v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[slot];
        v-&gt;<a class="code" href="structvirginian.html#acf3ed38504bbb207ffa500d1508cad97" title="id of the tablet in each slot, valid only if status is above 0">tablet_slot_ids</a>[slot] = id;
        meta[0]-&gt;<a class="code" href="structvirg__tablet__meta.html#a8287e9d36017a86bc3657de07cfbb47e" title="tablet id">id</a> = id;

        <span class="comment">// unloc</span>
        pthread_mutex_unlock(&amp;v-&gt;<a class="code" href="structvirginian.html#a26ed4b0163e1b8a4ac20898715519588" title="mutex for multi-core manipulation of the tablet slots">slot_lock</a>);

<span class="preprocessor">#ifdef VIRG_DEBUG_SLOTS</span>
<span class="preprocessor"></span>        fprintf(stderr, <span class="stringliteral">&quot;After alloc\n&quot;</span>);
        virg_print_slots(v);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga7a90f2b2186befe31067d4c13d3fa168"></a><!-- doxytag: member="clear.c::virg_db_clear" ref="ga7a90f2b2186befe31067d4c13d3fa168" args="(virginian *v, unsigned slot)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_db_clear </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>slot</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Clear out a certain tablet slot. </p>
<p>Clear out a tablet slot, specified with the 2nd argument, by writing the content of that tablet, then setting the appropriate values to indicate that the slot is now empty. This function is called for every tablet slot in <a class="el" href="group__database.html#ga8e2d3e3bf58554a5c2b58372c2211b66" title="Close the currently opened database.">virg_db_close()</a> to ensure that all tablet has been moved to disk. This function is not thread-safe, the tablet slot array must be locked outide of it.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">slot</td><td>Tablet slot to be cleared </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="clear_8c_source.html#l00020">20</a> of file <a class="el" href="clear_8c_source.html">clear.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="comment">// check the slot argument</span>
        <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[slot] == 0)
                <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;

        <span class="comment">// check to make sure that the tablet isn&#39;t locked</span>
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[slot] &gt; 1, <span class="stringliteral">&quot;Trying to clear a locked slot&quot;</span>)

        <span class="comment">// write the contents of the tablet to disk</span>
        <a class="code" href="group__database.html#gabba43a66f14c5ad7172401aa0005261f" title="Write the tablet in a tablet slot to disk.">virg_db_write</a>(v, slot);

        <span class="comment">// Note that the tablet slot is now empty</span>
        v-&gt;tablet_slot_status[slot] = 0;
        v-&gt;tablet_slots_taken--;

        return <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga8e2d3e3bf58554a5c2b58372c2211b66"></a><!-- doxytag: member="close.c::virg_db_close" ref="ga8e2d3e3bf58554a5c2b58372c2211b66" args="(virginian *v)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_db_close </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Close the currently opened database. </p>
<p>Close the open database. This is accomplished by clearing every single main-memory tablet slot, thus ensuring the changes to every tablet are reflected on disk, then writing the fixed-size <a class="el" href="structvirg__db.html" title="State of the currently open database.">virg_db</a> struct stored in the virginian state struct to the head of the database file, then writing the variable-sized meta information between this fixed-size area and the start of the actual tablets. The variable-size meta information is a list of all the tablets in the file. This function should be called only if no tablets are locked in memory.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="db_2close_8c_source.html#l00020">20</a> of file <a class="el" href="db_2close_8c_source.html">close.c</a>.</p>
<div class="fragment"><pre class="fragment">                                {
        <span class="keywordtype">unsigned</span> i, r;
        <span class="keywordtype">size_t</span> size;

        <span class="comment">// check that a database is currently open</span>
        <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#a736058b8d4409694d3d6013b4d92bcee" title="file descriptor for the open database">dbfd</a> == -1)
                <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;

        <span class="comment">// set size to the meta area of the file</span>
        size = <span class="keyword">sizeof</span>(<a class="code" href="structvirg__db.html" title="State of the currently open database.">virg_db</a>);
        size += v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a> * <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__info.html" title="Information associated with a tablet on disk.">virg_tablet_info</a>);

        <span class="comment">// clear every tablet slot, thus writing every in-memory tablet to disk</span>
        <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a>; i++)
                <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[i])
                        <a class="code" href="group__database.html#ga7a90f2b2186befe31067d4c13d3fa168" title="Clear out a certain tablet slot.">virg_db_clear</a>(v, i);

        <span class="comment">// write the fixed-size meta information in the virg_db struct to disk</span>
        r = pwrite(v-&gt;<a class="code" href="structvirginian.html#a736058b8d4409694d3d6013b4d92bcee" title="file descriptor for the open database">dbfd</a>, &amp;v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>, <span class="keyword">sizeof</span>(<a class="code" href="structvirg__db.html" title="State of the currently open database.">virg_db</a>), 0);
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(r &lt; <span class="keyword">sizeof</span>(<a class="code" href="structvirg__db.html" title="State of the currently open database.">virg_db</a>), <span class="stringliteral">&quot;Problem writing db meta info&quot;</span>);

        <span class="comment">// write the variable-sized meta information (the tablet slot use and ids)</span>
        <span class="comment">// to disk</span>
        size = v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a> * <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__info.html" title="Information associated with a tablet on disk.">virg_tablet_info</a>);
        r = pwrite(v-&gt;<a class="code" href="structvirginian.html#a736058b8d4409694d3d6013b4d92bcee" title="file descriptor for the open database">dbfd</a>, v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>, size, <span class="keyword">sizeof</span>(<a class="code" href="structvirg__db.html" title="State of the currently open database.">virg_db</a>));
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(r &lt; size, <span class="stringliteral">&quot;Problem writing db meta info&quot;</span>);

        <span class="comment">// close the database file</span>
        r = close(v-&gt;<a class="code" href="structvirginian.html#a736058b8d4409694d3d6013b4d92bcee" title="file descriptor for the open database">dbfd</a>);
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(r != 0, <span class="stringliteral">&quot;Problem closing file&quot;</span>);
        v-&gt;<a class="code" href="structvirginian.html#a736058b8d4409694d3d6013b4d92bcee" title="file descriptor for the open database">dbfd</a> = -1;

        <span class="comment">// free the variable size meta information block</span>
        free(v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>);

        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga1d9e0bce415badbfb3fc06c0021d9de4"></a><!-- doxytag: member="create.c::virg_db_create" ref="ga1d9e0bce415badbfb3fc06c0021d9de4" args="(virginian *v, const char *file)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_db_create </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create and initialize a new database. </p>
<p>Create a database by initializing the <a class="el" href="structvirg__db.html" title="State of the currently open database.">virg_db</a> struct that is stored within the virginian struct. The Virginian database can only have a single database open at once, so this should not be called if another database has been opened and has not yet been closed. Within the database struct we initialize our listing of tables and tablets, showing that each is empty. Additionally, we open the database file based on the the file argument, since we may need to write to it before <a class="el" href="group__database.html#ga8e2d3e3bf58554a5c2b58372c2211b66" title="Close the currently opened database.">virg_db_close()</a> is called.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">file</td><td>Location on disk where the database file should be written </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="db_2create_8c_source.html#l00020">20</a> of file <a class="el" href="db_2create_8c_source.html">create.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="keywordtype">unsigned</span> i;

        <a class="code" href="structvirg__db.html" title="State of the currently open database.">virg_db</a> *db = &amp;v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>;
        db-&gt;<a class="code" href="structvirg__db.html#a76f65c11efb2f4331dda033edfa513c2" title="number of tablets on disk">num_tablets</a> = 0;
        db-&gt;<a class="code" href="structvirg__db.html#a6657ccb6b05ec1b98ff5d5e868f4e1bc" title="used to assign unique ids to each data and result tablet">tablet_id_counter</a> = 0;
        v-&gt;<a class="code" href="structvirginian.html#a736058b8d4409694d3d6013b4d92bcee" title="file descriptor for the open database">dbfd</a> = -1;

        <span class="comment">// initialize the listing of tables</span>
        <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="virginian_8h.html#a6b400ca21647bb81159b1c459ef053e2" title="maximum tables supported">VIRG_MAX_TABLES</a>; i++) {
                db-&gt;<a class="code" href="structvirg__db.html#a581c152d798171bbe487a67b4e2d1471" title="maps table id to name">tables</a>[i][0] = <span class="charliteral">&#39;\0&#39;</span>;
                db-&gt;<a class="code" href="structvirg__db.html#a5f9dfe5476b490458ef529b57508cfb2" title="note which table slots have been used">table_status</a>[i] = 0;
                db-&gt;<a class="code" href="structvirg__db.html#acd5ea5ce0d1eaf0910665ba8db39161c" title="number of tablets for each table">table_tablets</a>[i] = 0;
                db-&gt;<a class="code" href="structvirg__db.html#aab4e0db684c30a32f0cc82f25274c576" title="tablet id of the current write location for adding rows to a table">write_cursor</a>[i] = 0;
        }

        <span class="comment">// initialize tablet information</span>
        db-&gt;<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a> = <a class="code" href="virginian_8h.html#a322fb6fe4d60ffeb3e91ca70114d1654" title="initial disk slot meta informations to allocate for tablets">VIRG_TABLET_INFO_SIZE</a>;
        <span class="keywordtype">size_t</span> size = <a class="code" href="virginian_8h.html#a322fb6fe4d60ffeb3e91ca70114d1654" title="initial disk slot meta informations to allocate for tablets">VIRG_TABLET_INFO_SIZE</a> * <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__info.html" title="Information associated with a tablet on disk.">virg_tablet_info</a>);
        db-&gt;<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a> = malloc(size);
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(db-&gt;<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a> == NULL, <span class="stringliteral">&quot;Out of memory&quot;</span>);
        db-&gt;<a class="code" href="structvirg__db.html#a3c79e95bc329543a931b29c57a4a829b" title="size of this struct plus all the virg_tablet_info structs">block_size</a> = <span class="keyword">sizeof</span>(<a class="code" href="structvirg__db.html" title="State of the currently open database.">virg_db</a>) + size;

<span class="preprocessor">#ifdef VIRG_DEBUG</span>
<span class="preprocessor"></span>        <span class="comment">// zero out malloced block for valgrind</span>
        memset(db-&gt;<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>, 0xDEADBEEF, size);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
        <span class="comment">// make sure every tablet slot is noted as not being used</span>
        <span class="keywordflow">for</span>(i = 0; i &lt; db-&gt;<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a>; i++)
                db-&gt;<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#a5d254b530b1e2bf333f614c96afefe6f" title="note whether or not there is a tablet stored in this disk slot">used</a> = 0;

        <span class="comment">// open database file on disk</span>
        v-&gt;<a class="code" href="structvirginian.html#a736058b8d4409694d3d6013b4d92bcee" title="file descriptor for the open database">dbfd</a> = open(file, O_RDWR|O_CREAT|O_EXCL, S_IRUSR|S_IWUSR|S_IRGRP|S_IROTH);
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(v-&gt;<a class="code" href="structvirginian.html#a736058b8d4409694d3d6013b4d92bcee" title="file descriptor for the open database">dbfd</a> &lt; 0, <span class="stringliteral">&quot;Problem creating file&quot;</span>)

        return <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga82086192c59cb1cb6dce14cbccdc4554"></a><!-- doxytag: member="findslot.c::virg_db_findslot" ref="ga82086192c59cb1cb6dce14cbccdc4554" args="(virginian *v, unsigned *slot_)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_db_findslot </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned *&#160;</td>
          <td class="paramname"><em>slot_</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Find an empty or unlocked tablet slot. </p>
<p>Attempt to find a tablet slot that is unoccupied. If all tablet slots are occupied, then attempt to find one that is not locked. If one is found, the contents of that tablet are written to disk, and the slot number is returned. Otherwise return a failure. This function is not thread-safe, so the tablet slot array must be locked outside of it in a multi-threaded environment.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">slot</td><td>Pointer to an unsigned integer through which the found slot will be returned </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="findslot_8c_source.html#l00019">19</a> of file <a class="el" href="findslot_8c_source.html">findslot.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="keywordtype">unsigned</span> slot;

        <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#ab4ab09cb712e32031e114b442c0c8157" title="number of tablet slots which are unused">tablet_slots_taken</a> &lt; <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a>) { <span class="comment">// theres an empty slot</span>
                <span class="keywordflow">for</span>(slot = 0; ; slot++) { <span class="comment">// assume we&#39;ll find empty slot before end</span>
                        <span class="comment">// check that this assumption is true</span>
                        assert(slot &lt; <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a>);

                        <span class="comment">// if the tablet is empty, break bc we found our slot</span>
                        <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[slot] == 0)
                                <span class="keywordflow">break</span>;
                }
                <span class="comment">// lock the tablet</span>
                v-&gt;<a class="code" href="structvirginian.html#ab4ab09cb712e32031e114b442c0c8157" title="number of tablet slots which are unused">tablet_slots_taken</a>++;
                v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[slot] = 2;
        }
        <span class="keywordflow">else</span> {
                <span class="comment">// get our round-robin starting location and increment it</span>
                slot = v-&gt;<a class="code" href="structvirginian.html#a5decd7c40e471d59f7d423669495f13a" title="round-robin counter to kick out tablets">tablet_slot_counter</a>++;
                <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#a5decd7c40e471d59f7d423669495f13a" title="round-robin counter to kick out tablets">tablet_slot_counter</a> &gt;= <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a>)
                        v-&gt;<a class="code" href="structvirginian.html#a5decd7c40e471d59f7d423669495f13a" title="round-robin counter to kick out tablets">tablet_slot_counter</a> = 0;

                <span class="keywordtype">unsigned</span> checked = 0;

                <span class="comment">// search for an occupied but unlocked tablet</span>
                <span class="keywordflow">for</span>( ; checked &lt; <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a> &amp;&amp; v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[slot] &gt; 1;
                        checked++, slot = (slot + 1) % <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a>);

                <span class="comment">// fail if everything is locked</span>
                <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(slot == <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a>, <span class="stringliteral">&quot;All tablets locked&quot;</span>)

                assert(v-&gt;tablet_slot_status[slot] == 1);
                v-&gt;tablet_slot_status[slot]++;

                <span class="comment">// write the slot contents to disk but don&#39;t assign new id bc we don&#39;t</span>
                <span class="comment">// know it</span>
                <a class="code" href="group__database.html#gabba43a66f14c5ad7172401aa0005261f" title="Write the tablet in a tablet slot to disk.">virg_db_write</a>(v, slot);
        }

        <span class="comment">// return tablet slot number</span>
        slot_[0] = slot;

        return <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga45ebb12f5cd1cb668f06dcc64fd815a0"></a><!-- doxytag: member="load.c::virg_db_load" ref="ga45ebb12f5cd1cb668f06dcc64fd815a0" args="(virginian *v, unsigned tablet_id, virg_tablet_meta **tab)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_db_load </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>tablet_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> **&#160;</td>
          <td class="paramname"><em>tab</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Load a tablet into a slot based on its ID and return a pointer. </p>
<p>This function is used when you are attempting to access a tablet based on its ID. It will add a read-lock for the tablet and return a pointer to it. For efficiency, it first checks to see if the tablet already resides in a main-memory tablet slot. If it does, we simple add the lock and return the pointer. Otherwise we must fetch the tablet from the database file on disk and read it into a tablet slot. This function is thread-safe and performs several checks to ensure that the tablet ID actually exists and that the expected size of the tablet is actually read.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">tablet_id</td><td>The ID of the tablet being loaded </td></tr>
    <tr><td class="paramname">tab</td><td>A pointer to a tablet pointer through which the location of the loaded tablet is returned </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="load_8c_source.html#l00022">22</a> of file <a class="el" href="load_8c_source.html">load.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="keywordtype">unsigned</span> i;
        <span class="keywordtype">unsigned</span> slot;

        <span class="comment">// lock all the tablet slots</span>
        pthread_mutex_lock(&amp;v-&gt;<a class="code" href="structvirginian.html#a26ed4b0163e1b8a4ac20898715519588" title="mutex for multi-core manipulation of the tablet slots">slot_lock</a>);

        <span class="comment">// check if the tablet is already loaded</span>
        <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a>; i++)
                <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[i] != 0 &amp;&amp; v-&gt;<a class="code" href="structvirginian.html#acf3ed38504bbb207ffa500d1508cad97" title="id of the tablet in each slot, valid only if status is above 0">tablet_slot_ids</a>[i] == tablet_id) {
                        <span class="keywordflow">if</span>(tab != NULL)
                                tab[0] = v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[i];

                        <span class="comment">// if so, add an extra tablet lock and return the pointer</span>
                        v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[i]++;
                        pthread_mutex_unlock(&amp;v-&gt;<a class="code" href="structvirginian.html#a26ed4b0163e1b8a4ac20898715519588" title="mutex for multi-core manipulation of the tablet slots">slot_lock</a>);
                        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
                }

        <span class="comment">// if not already loaded, find an empty slot</span>
        <a class="code" href="group__database.html#ga82086192c59cb1cb6dce14cbccdc4554" title="Find an empty or unlocked tablet slot.">virg_db_findslot</a>(v, &amp;slot);

        <span class="comment">// find tablet on disk using the virg_db meta information</span>
        <span class="keywordflow">for</span>(i = 0; i &lt; v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a>; i++)
                <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#a5d254b530b1e2bf333f614c96afefe6f" title="note whether or not there is a tablet stored in this disk slot">used</a> == 1
                        &amp;&amp; v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#ac3d14971c28b9823b686ab0b848002b2" title="id of the tablet stored in this slot, valid only if used == 1">id</a> == tablet_id)
                        <span class="keywordflow">break</span>;

        <span class="comment">// make sure the tablet id was found</span>
        <span class="comment">// the tablet should never not be found, and it indicates a corrupt database</span>
        <span class="comment">// file</span>
<span class="preprocessor">#ifdef VIRG_DEBUG</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span>(i == v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a>) {
                fprintf(stderr, <span class="stringliteral">&quot;LOOKING FOR %u\n&quot;</span>, tablet_id);
                virg_print_tablet_info(v);
        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(i == v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a>, <span class="stringliteral">&quot;Could not find tablet id&quot;</span>)

        <span class="comment">// get tablet meta information from disk</span>
        off_t x = v-&gt;db.block_size + i * <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a>;
        <span class="keywordtype">unsigned</span> r = pread(v-&gt;dbfd, v-&gt;tablet_slots[slot], sizeof(<a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a>), x);
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(r &lt; (<span class="keywordtype">int</span>)sizeof(virg_tablet_meta), &quot;Failed to get tablet <a class="code" href="vm__gpu_8cu.html#a98365893b0ed61f342c55a901d47b738">meta</a> data&quot;)

        <span class="comment">// get the rest of the tablet from disk</span>
        r = pread(v-&gt;dbfd,
                (<span class="keywordtype">char</span>*)v-&gt;tablet_slots[slot] + sizeof(virg_tablet_meta),
                v-&gt;tablet_slots[slot]-&gt;size - sizeof(virg_tablet_meta),
                x + sizeof(virg_tablet_meta));

        <span class="comment">// if for some reason the pread() call returned fewer bytes than it was</span>
        <span class="comment">// supposed to, complain because the database file is corrupted</span>
<span class="preprocessor">#ifdef VIRG_DEBUG</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span>(r &lt; v-&gt;tablet_slots[slot]-&gt;size - <span class="keyword">sizeof</span>(virg_tablet_meta)) {
                fprintf(stderr, <span class="stringliteral">&quot;COULDN&#39;T GET TABLET DATA\n&quot;</span>);
                fprintf(stderr, <span class="stringliteral">&quot;LOOKING FOR %u\n&quot;</span>, tablet_id);
                virg_print_tablet_meta(v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[slot]);
                virg_print_tablet_info(v);
        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(r &lt; v-&gt;tablet_slots[slot]-&gt;size -
                <span class="keyword">sizeof</span>(virg_tablet_meta), <span class="stringliteral">&quot;Failed to get tablet data&quot;</span>)

        <span class="comment">// set the appropriate tablet data</span>
        v-&gt;tablet_slots[slot]-&gt;info = &amp;v-&gt;db.tablet_info[i];
        v-&gt;tablet_slot_ids[slot] = tablet_id;

        <span class="comment">// return a pointer to the loaded tablet</span>
        if(tab != NULL)
                tab[0] = v-&gt;tablet_slots[slot];

        <span class="comment">// unlock tablet array lock</span>
        pthread_mutex_unlock(&amp;v-&gt;slot_lock);

        return <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga78584f2bb7ca78e1cb87378929ce40f2"></a><!-- doxytag: member="loadnext.c::virg_db_loadnext" ref="ga78584f2bb7ca78e1cb87378929ce40f2" args="(virginian *v, virg_tablet_meta **tab)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_db_loadnext </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> **&#160;</td>
          <td class="paramname"><em>tab</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Advance a tablet pointer to the next tablet in its string of tablets. </p>
<p>This is a convenience function used to handle the correct locking and unlocking as we walk along a string of tablets by using the <a class="el" href="structvirg__tablet__meta.html#a08bff8a2b2cbe7abbbdb0e85a530b065" title="id of the next tablet in the tablet string">virg_tablet_meta.next</a> information. It uses a temporary pointer to safely load the next tablet before unlocking the current one. It then advances the passed pointer to this new tablet. Note that a check to ensure that the current tablet is not the last in the tablet string should be performed before calling this function.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">tab</td><td>Pointer to a tablet pointer to be pointed to the next tablet </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="loadnext_8c_source.html#l00021">21</a> of file <a class="el" href="loadnext_8c_source.html">loadnext.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="comment">// temporary tablet pointer</span>
        <a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a> *t = tab[0];

        <span class="comment">// load the next pointer while the current one is still locked</span>
        <a class="code" href="group__database.html#ga45ebb12f5cd1cb668f06dcc64fd815a0" title="Load a tablet into a slot based on its ID and return a pointer.">virg_db_load</a>(v, t-&gt;<a class="code" href="structvirg__tablet__meta.html#a08bff8a2b2cbe7abbbdb0e85a530b065" title="id of the next tablet in the tablet string">next</a>, tab);

        <span class="comment">// unlock the old tablet</span>
        <a class="code" href="group__tablet.html#ga8e6a3f46a4efe9347c8202acc032db69" title="Release a lock to a tablet.">virg_tablet_unlock</a>(v, t-&gt;<a class="code" href="structvirg__tablet__meta.html#a8287e9d36017a86bc3657de07cfbb47e" title="tablet id">id</a>);

        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="gabbd5a202240db94bc243bab127c8157d"></a><!-- doxytag: member="open.c::virg_db_open" ref="gabbd5a202240db94bc243bab127c8157d" args="(virginian *v, const char *file)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_db_open </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Open an existing database file. </p>
<p>Open a database that already exists from its location on disk. This function reads the database meta information into memory, but does not load any tablets into memory. Open databases should be closed with the <a class="el" href="group__database.html#ga8e2d3e3bf58554a5c2b58372c2211b66" title="Close the currently opened database.">virg_db_close()</a> function and created with the <a class="el" href="group__database.html#ga1d9e0bce415badbfb3fc06c0021d9de4" title="Create and initialize a new database.">virg_db_create()</a> function. This function sets the information in the <a class="el" href="structvirg__db.html" title="State of the currently open database.">virg_db</a> struct stored within the passed virginian struct. Only one database can be open at a time, so this function should only be called if there are no other open databases.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">file</td><td>Location on disk of the database file </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="open_8c_source.html#l00020">20</a> of file <a class="el" href="open_8c_source.html">open.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="keywordtype">int</span> fd;
        <span class="keywordtype">size_t</span> r;

        <span class="comment">// ensure that no database is currently open</span>
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(v-&gt;<a class="code" href="structvirginian.html#a736058b8d4409694d3d6013b4d92bcee" title="file descriptor for the open database">dbfd</a> != -1, <span class="stringliteral">&quot;Database already open&quot;</span>)

        <span class="comment">// open the database file for reading and writing</span>
        fd = open(file, O_RDWR, S_IRUSR | S_IWUSR);
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(fd == -1, &quot;Problem opening database file&quot;)
        v-&gt;dbfd = fd;

        <span class="comment">// read the fixed size meta information into our virg_db struct</span>
        r = read(fd, &amp;v-&gt;db, sizeof(<a class="code" href="structvirg__db.html" title="State of the currently open database.">virg_db</a>));
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(r &lt; sizeof(virg_db), &quot;Corrupt database file&quot;)

        <span class="comment">// allocate an area for the variable-size tablet tracking information</span>
        <span class="comment">// even if there are no tablets, alloced_tablets is set to non-zero when the</span>
        <span class="comment">// database is created</span>
        <span class="keywordtype">size_t</span> size = v-&gt;db.alloced_tablets * sizeof(<a class="code" href="structvirg__tablet__info.html" title="Information associated with a tablet on disk.">virg_tablet_info</a>);
        v-&gt;db.tablet_info = (virg_tablet_info*) malloc(size);
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(v-&gt;db.tablet_info == NULL, &quot;Out of memory&quot;)

        <span class="comment">// read the meta-information from disk</span>
        r = read(fd, v-&gt;db.tablet_info, size);
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(r &lt; size, &quot;Problem reading tablet info&quot;)

        return <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="gabba43a66f14c5ad7172401aa0005261f"></a><!-- doxytag: member="write.c::virg_db_write" ref="gabba43a66f14c5ad7172401aa0005261f" args="(virginian *v, unsigned slot)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_db_write </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>slot</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Write the tablet in a tablet slot to disk. </p>
<p>This function writes the tablet in a tablet slot to an area of the on-disk database file. It is not thread-safe, so locking of the tablet slot array and the tablet should be performed in a multi-threaded environment. This function handles updating the disk slot meta information about where tablets are stored.</p>
<p>This function is somewhat complex because of the variable-sized disk meta information. The on-disk database stores a fixed-size block of meta information that corresponds to a <a class="el" href="structvirg__db.html" title="State of the currently open database.">virg_db</a> struct. The listing of the tablet IDs in the database file is of a variable size because we can have an arbitrarily large number of tablets stored in the file. After the tablet listing, we store actual tablets. Note that this variable-size tablet list, or tablet info block, is stored in memory while the database is open and written to disk when the database closes. Under this scheme, we often exceed the currently allocated size of this tablet list, in which case we must allocate a larger area and copy the contents to the new allocation. Problems arise, however, because this new larger size may intersect with the first tablet in the database file, in which case we must move this tablet to the back of the list, and move on disk if it is not loaded into memory, to make more room for our tablet list in the database file. A significant portion of this function is devoted to this edge case.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">slot</td><td>The number of the tablet slot to be written to disk </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="write_8c_source.html#l00034">34</a> of file <a class="el" href="write_8c_source.html">write.c</a>.</p>
<div class="fragment"><pre class="fragment">{
<span class="preprocessor">#ifdef VIRG_DEBUG_SLOTS</span>
<span class="preprocessor"></span>        <span class="comment">// tablet movement debug information</span>
        fprintf(stderr, <span class="stringliteral">&quot;WRITE TABLET ID %u\n&quot;</span>, v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[slot]-&gt;<a class="code" href="structvirg__tablet__meta.html#a8287e9d36017a86bc3657de07cfbb47e" title="tablet id">id</a>);
        virg_print_slots(v);
        virg_print_tablet_info(v);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
        <span class="keywordtype">unsigned</span> i, r;
        <span class="keywordtype">size_t</span> offset = v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a3c79e95bc329543a931b29c57a4a829b" title="size of this struct plus all the virg_tablet_info structs">block_size</a>;

        <span class="comment">// ptr to tablet slot</span>
        <a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a> *tab = v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[slot];

        <span class="comment">// if the tablet already has an allocated spot on disk</span>
        <span class="keywordflow">if</span>(tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a5bd107899dc507b45e96fd2c020aa533" title="pointer to the disk info struct associated with this tablet">info</a> != NULL) {
                offset += tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a5bd107899dc507b45e96fd2c020aa533" title="pointer to the disk info struct associated with this tablet">info</a>-&gt;<a class="code" href="structvirg__tablet__info.html#aea94d27175afab1fdcad4d186e5e75eb" title="the index of this struct in the array of tablet infos">disk_slot</a> * <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a>;
        }
        <span class="comment">// not written to disk</span>
        <span class="keywordflow">else</span> {
                <span class="comment">// find an empty spot on disk</span>
                <span class="keywordflow">for</span>(i = 0; i &lt; v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a>; i++)
                        <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#a5d254b530b1e2bf333f614c96afefe6f" title="note whether or not there is a tablet stored in this disk slot">used</a> == 0)
                                <span class="keywordflow">break</span>;

                <span class="comment">// if no empty spot, expand info area, disk expands implicitly</span>
                <span class="keywordflow">if</span>(i &gt;= v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a>) {
                        <span class="keywordtype">unsigned</span> new_alloced_tablets = v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a> +
                                <a class="code" href="virginian_8h.html#a002840681a46089ae65d9b4cf6a2eb50" title="meta information structs to add when all are used up and we need another">VIRG_TABLET_INFO_INCREMENT</a>;
                        <span class="keywordtype">size_t</span> size = new_alloced_tablets * <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__info.html" title="Information associated with a tablet on disk.">virg_tablet_info</a>);

                        <span class="comment">// if the expanded info area still fits in the space before the</span>
                        <span class="comment">// first tablet</span>
                        <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a3c79e95bc329543a931b29c57a4a829b" title="size of this struct plus all the virg_tablet_info structs">block_size</a> &gt;= size + <span class="keyword">sizeof</span>(<a class="code" href="structvirg__db.html" title="State of the currently open database.">virg_db</a>)) {
                                <span class="comment">// allocate a bigger area in memory</span>
                                <a class="code" href="structvirg__tablet__info.html" title="Information associated with a tablet on disk.">virg_tablet_info</a> *info = malloc(size);
                                <span class="comment">// copy the tablet info in memory into the newly allocated block</span>
                                memcpy(info, v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>, v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a> *
                                        <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__info.html" title="Information associated with a tablet on disk.">virg_tablet_info</a>));

                                <span class="comment">// update pointers in in-memory tablets to the new tablet info</span>
                                <span class="comment">// block</span>
                                <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a>; i++)
                                        <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[i] != 0 &amp;&amp;
                                                v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[i]-&gt;<a class="code" href="structvirg__tablet__meta.html#a5bd107899dc507b45e96fd2c020aa533" title="pointer to the disk info struct associated with this tablet">info</a> != NULL)
                                                v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[i]-&gt;<a class="code" href="structvirg__tablet__meta.html#a5bd107899dc507b45e96fd2c020aa533" title="pointer to the disk info struct associated with this tablet">info</a> =
                                                        &amp;info[v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[i]-&gt;<a class="code" href="structvirg__tablet__meta.html#a5bd107899dc507b45e96fd2c020aa533" title="pointer to the disk info struct associated with this tablet">info</a>-&gt;<a class="code" href="structvirg__tablet__info.html#aea94d27175afab1fdcad4d186e5e75eb" title="the index of this struct in the array of tablet infos">disk_slot</a>];

                                <span class="comment">// free the old tablet info block</span>
                                free(v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>);
                                v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a> = info;

                                <span class="comment">// initialize the new area of the tablet info block</span>
                                <span class="keywordflow">for</span>(i = v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a>; i &lt; new_alloced_tablets; i++) {
                                        v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#a5d254b530b1e2bf333f614c96afefe6f" title="note whether or not there is a tablet stored in this disk slot">used</a> = 0;
                                        v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#aea94d27175afab1fdcad4d186e5e75eb" title="the index of this struct in the array of tablet infos">disk_slot</a> = i;
<span class="preprocessor">#ifdef VIRG_DEBUG</span>
<span class="preprocessor"></span>                                        v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#ac3d14971c28b9823b686ab0b848002b2" title="id of the tablet stored in this slot, valid only if used == 1">id</a> = 0xDEADBEEF;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                                }

                                <span class="comment">// use the first newly allocated slot</span>
                                i = v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a>;
                                v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a> = new_alloced_tablets;
                        }
                        <span class="comment">// the newly allocated tablet info block is big enough to intersect</span>
                        <span class="comment">// with the first tablet stored on disk</span>
                        <span class="comment">// resize tablet info block and move first tablet to the back</span>
                        <span class="keywordflow">else</span> {
                                <span class="comment">// allocate new info block and copy with the first moved to the</span>
                                <span class="comment">// last</span>
                                <a class="code" href="structvirg__tablet__info.html" title="Information associated with a tablet on disk.">virg_tablet_info</a> *info = malloc(size);
                                memcpy(info, v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a> + 1,
                                        (v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a> - 1) * <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__info.html" title="Information associated with a tablet on disk.">virg_tablet_info</a>));
                                memcpy(info + v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a> - 1, v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>,
                                        <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__info.html" title="Information associated with a tablet on disk.">virg_tablet_info</a>));

                                <span class="comment">// update the disk slot information because we&#39;ve shifted things</span>
                                <span class="keywordflow">for</span>(i = 0; i &lt; v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a>; i++)
                                        info[i].disk_slot = i;
                                <span class="keywordflow">for</span>( ; i &lt; new_alloced_tablets; i++) {
                                        info[i].<a class="code" href="structvirg__tablet__info.html#a5d254b530b1e2bf333f614c96afefe6f" title="note whether or not there is a tablet stored in this disk slot">used</a> = 0;
                                        info[i].<a class="code" href="structvirg__tablet__info.html#aea94d27175afab1fdcad4d186e5e75eb" title="the index of this struct in the array of tablet infos">disk_slot</a> = i;
<span class="preprocessor">#ifdef VIRG_DEBUG</span>
<span class="preprocessor"></span>                                        info[i].<a class="code" href="structvirg__tablet__info.html#ac3d14971c28b9823b686ab0b848002b2" title="id of the tablet stored in this slot, valid only if used == 1">id</a> = 0xDEADBEEF;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                                }

                                <span class="keywordtype">int</span> found_first = 0;

                                <span class="comment">// update pointers in in-memory tablets to the new tablet info</span>
                                <span class="comment">// block</span>
                                <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a>; i++)
                                        <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[i] != 0) {
                                                <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#acf3ed38504bbb207ffa500d1508cad97" title="id of the tablet in each slot, valid only if status is above 0">tablet_slot_ids</a>[i] == v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[0].<a class="code" href="structvirg__tablet__info.html#ac3d14971c28b9823b686ab0b848002b2" title="id of the tablet stored in this slot, valid only if used == 1">id</a>) {
                                                        v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[i]-&gt;<a class="code" href="structvirg__tablet__meta.html#a5bd107899dc507b45e96fd2c020aa533" title="pointer to the disk info struct associated with this tablet">info</a> = &amp;info[v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a> - 1];
                                                        found_first = 1;
                                                }
                                                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[i]-&gt;<a class="code" href="structvirg__tablet__meta.html#a5bd107899dc507b45e96fd2c020aa533" title="pointer to the disk info struct associated with this tablet">info</a> != NULL) {
                                                        v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[i]-&gt;<a class="code" href="structvirg__tablet__meta.html#a5bd107899dc507b45e96fd2c020aa533" title="pointer to the disk info struct associated with this tablet">info</a> = &amp;info[v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[i]-&gt;<a class="code" href="structvirg__tablet__meta.html#a5bd107899dc507b45e96fd2c020aa533" title="pointer to the disk info struct associated with this tablet">info</a>-&gt;<a class="code" href="structvirg__tablet__info.html#aea94d27175afab1fdcad4d186e5e75eb" title="the index of this struct in the array of tablet infos">disk_slot</a> - 1];
                                                }
                                        }

                                <span class="comment">// if the first tablet in the info block isn&#39;t in memory, then</span>
                                <span class="comment">// we must move it on disk so that it isn&#39;t overwritten</span>
                                <span class="keywordflow">if</span>(!found_first) {
                                        <span class="keywordtype">void</span> *buff = malloc(<a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a>);
                                        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(buff == NULL, <span class="stringliteral">&quot;Could not allocate temporary memory&quot;</span>);
                                        ssize_t r = pread(v-&gt;<a class="code" href="structvirginian.html#a736058b8d4409694d3d6013b4d92bcee" title="file descriptor for the open database">dbfd</a>, buff, <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a>,
                                                v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a3c79e95bc329543a931b29c57a4a829b" title="size of this struct plus all the virg_tablet_info structs">block_size</a>);
                                        assert(r &gt; 0);

                                        r = pwrite(v-&gt;<a class="code" href="structvirginian.html#a736058b8d4409694d3d6013b4d92bcee" title="file descriptor for the open database">dbfd</a>, buff, <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a>,
                                                v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a3c79e95bc329543a931b29c57a4a829b" title="size of this struct plus all the virg_tablet_info structs">block_size</a> + <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a> *
                                                v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a>);
                                        assert(r &gt; 0);

                                        free(buff);
                                }

                                <span class="comment">// free the old in-memory tablet info</span>
                                free(v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>);

                                <span class="comment">// use the first disk slot of the newly allocated area</span>
                                v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a> = info;
                                i = v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a>;
                                v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a> = new_alloced_tablets;
                                v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a3c79e95bc329543a931b29c57a4a829b" title="size of this struct plus all the virg_tablet_info structs">block_size</a> += <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a>;
                        }
                }

                <span class="comment">// set out disk offset and the tablet info before writing</span>
                offset = v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a3c79e95bc329543a931b29c57a4a829b" title="size of this struct plus all the virg_tablet_info structs">block_size</a>;
                offset += i * <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a>;
                v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#a5d254b530b1e2bf333f614c96afefe6f" title="note whether or not there is a tablet stored in this disk slot">used</a> = 1;
                v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#ac3d14971c28b9823b686ab0b848002b2" title="id of the tablet stored in this slot, valid only if used == 1">id</a> = tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a8287e9d36017a86bc3657de07cfbb47e" title="tablet id">id</a>;
                v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#aea94d27175afab1fdcad4d186e5e75eb" title="the index of this struct in the array of tablet infos">disk_slot</a> = i;
        }

        <span class="comment">// perform the tablet write to disk</span>
        r = pwrite(v-&gt;<a class="code" href="structvirginian.html#a736058b8d4409694d3d6013b4d92bcee" title="file descriptor for the open database">dbfd</a>, tab, tab-&gt;<a class="code" href="structvirg__tablet__meta.html#ad65a3feff0d4d970d956214bc658a962" title="total size of this tablet">size</a>, offset);
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(r &lt; tab-&gt;size, <span class="stringliteral">&quot;Failed to write tablet&quot;</span>)

        return <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Wed Feb 15 2012 01:21:46 for Virginian by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
