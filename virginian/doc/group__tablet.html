<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Virginian: Tablet Functions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Virginian</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Tablet Functions</div>  </div>
</div>
<div class="contents">
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__tablet.html#gad8e8dfe554d09257dbccd44b7bc35f2c">virg_tablet_addcolumn</a> (<a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> *tab, const char *name, <a class="el" href="virginian_8h.html#a5edb977d9e195d5df43f1757f311292b">virg_t</a> type)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Add a column to a tablet.  <a href="#gad8e8dfe554d09257dbccd44b7bc35f2c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__tablet.html#ga91abf3ca31d24bdc6be4b30ca0840d03">virg_tablet_addmaxrows</a> (<a class="el" href="structvirginian.html">virginian</a> *v, <a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> *tab)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Maximize the fixed-size block of the tablet.  <a href="#ga91abf3ca31d24bdc6be4b30ca0840d03"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__tablet.html#gad8a1519a69a43f924a94cec0a691392c">virg_tablet_addrows</a> (<a class="el" href="structvirginian.html">virginian</a> *v, <a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> *tab, unsigned rows)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Add fixed-size rows to a tablet.  <a href="#gad8a1519a69a43f924a94cec0a691392c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__tablet.html#ga3798b847b682e36ff95826f3aea15e70">virg_tablet_addtail</a> (<a class="el" href="structvirginian.html">virginian</a> *v, <a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> *head, <a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> **tail, unsigned possible_rows)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize a result tablet reader.  <a href="#ga3798b847b682e36ff95826f3aea15e70"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__tablet.html#ga63806dc508073da387d045837f0d7e9d">virg_tablet_check</a> (<a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> *t)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Ensure that the tablet is internally consistent and conforms to expectation.  <a href="#ga63806dc508073da387d045837f0d7e9d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__tablet.html#gac81bdeda780fac6917c8942bec57a581">virg_tablet_create</a> (<a class="el" href="structvirginian.html">virginian</a> *v, int *id, <a class="el" href="virginian_8h.html#a5edb977d9e195d5df43f1757f311292b">virg_t</a> key_type, unsigned table_id)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Create an empty tablet for a new table.  <a href="#gac81bdeda780fac6917c8942bec57a581"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__tablet.html#gaaa3df8caa444c2afb156e0b4673fc492">virg_tablet_growfixed</a> (<a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> *tab, size_t size)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Grows the fixed_block of a tablet by moving the variable block back.  <a href="#gaaa3df8caa444c2afb156e0b4673fc492"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__tablet.html#gabd69b51cf1469c95d1574b1d53935391">virg_tablet_lock</a> (<a class="el" href="structvirginian.html">virginian</a> *v, unsigned tablet_id)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Add a lock to a tablet.  <a href="#gabd69b51cf1469c95d1574b1d53935391"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__tablet.html#ga8e6a3f46a4efe9347c8202acc032db69">virg_tablet_unlock</a> (<a class="el" href="structvirginian.html">virginian</a> *v, unsigned tablet_id)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Release a lock to a tablet.  <a href="#ga8e6a3f46a4efe9347c8202acc032db69"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__tablet.html#ga00875121a2be660a42c7633b13d0e27c">virg_tablet_remove</a> (<a class="el" href="structvirginian.html">virginian</a> *v, unsigned id)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Deletes a tablet from memory and disk.  <a href="#ga00875121a2be660a42c7633b13d0e27c"></a><br/></td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="gad8e8dfe554d09257dbccd44b7bc35f2c"></a><!-- doxytag: member="addcolumn.c::virg_tablet_addcolumn" ref="gad8e8dfe554d09257dbccd44b7bc35f2c" args="(virg_tablet_meta *tab, const char *name, virg_t type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_tablet_addcolumn </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> *&#160;</td>
          <td class="paramname"><em>tab</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="virginian_8h.html#a5edb977d9e195d5df43f1757f311292b">virg_t</a>&#160;</td>
          <td class="paramname"><em>type</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add a column to a tablet. </p>
<p>Modifies a tablet, including making it larger, to contain a new column, added to the end of the original columns. This function does not check to ensure that there is enough room in the tablet for the new column, so columns should be added only if there is a good amount of empty space in the tablet. The <a class="el" href="group__tablet.html#gaaa3df8caa444c2afb156e0b4673fc492" title="Grows the fixed_block of a tablet by moving the variable block back.">virg_tablet_growfixed()</a> function is used to expand the tablet.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">tab</td><td>The tablet to which the column is to be added </td></tr>
    <tr><td class="paramname">name</td><td>The name of the column to add </td></tr>
    <tr><td class="paramname">type</td><td>The variable type of the column to add </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="_2addcolumn_8c_source.html#l00019">19</a> of file <a class="el" href="_2addcolumn_8c_source.html">addcolumn.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="keywordtype">int</span> i;
        <span class="keywordtype">int</span> col = tab-&gt;<a class="code" href="structvirg__tablet__meta.html#aa3595a9a97105ce081422911c30c0269" title="number of fixed-size columns">fixed_columns</a>;

        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(col == <a class="code" href="virginian_8h.html#a9c9a2a8531dbc0da7a03ccd1a8cd00f7" title="maximum table columns supported">VIRG_MAX_COLUMNS</a>, <span class="stringliteral">&quot;Too many columns&quot;</span>)

        <span class="comment">// copy column name</span>
        <span class="comment">// length checked in virg_table_addcolumn()</span>
        for(i = 0; name[i] != &#39;\0&#39;; i++)
                tab-&gt;fixed_name[col][i] = name[i];
        tab-&gt;fixed_name[col][i] = &#39;\0&#39;;

        <span class="comment">// set column information</span>
        tab-&gt;fixed_type[col] = type;
        tab-&gt;fixed_stride[col] = virg_sizeof(type);
        tab-&gt;row_stride += virg_sizeof(type);
        tab-&gt;fixed_offset[col] =
                (col == 0) ? 0 : tab-&gt;fixed_offset[col-1] + tab-&gt;fixed_stride[col-1] * tab-&gt;possible_rows;
        tab-&gt;fixed_columns++;

        <span class="comment">// make room in the tablet for the new column</span>
        <a class="code" href="group__tablet.html#gaaa3df8caa444c2afb156e0b4673fc492" title="Grows the fixed_block of a tablet by moving the variable block back.">virg_tablet_growfixed</a>(tab, tab-&gt;fixed_stride[col] * tab-&gt;possible_rows);

        return <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga91abf3ca31d24bdc6be4b30ca0840d03"></a><!-- doxytag: member="addmaxrows.c::virg_tablet_addmaxrows" ref="ga91abf3ca31d24bdc6be4b30ca0840d03" args="(virginian *v, virg_tablet_meta *tab)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_tablet_addmaxrows </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> *&#160;</td>
          <td class="paramname"><em>tab</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Maximize the fixed-size block of the tablet. </p>
<p>Add as many rows as possible to the fixed-size data block of a tablet. This function returns VIRG_FAIL if the tablet has already been maxed.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">tab</td><td>Pointer to the tablet to be modified </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="addmaxrows_8c_source.html#l00015">15</a> of file <a class="el" href="addmaxrows_8c_source.html">addmaxrows.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="comment">// calculate the the unused space in the tablet</span>
        <span class="keywordtype">size_t</span> stride = tab-&gt;<a class="code" href="structvirg__tablet__meta.html#ae0d98c019521326affbcab24362a7c71" title="stride of fixed-size columns, including key and key pointer">row_stride</a>;
        <span class="keywordtype">size_t</span> avail = <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a> - <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a>) - <a class="code" href="virginian_8h.html#a634ca639104eef31bd6787366466a2d1" title="size reserved for the variable block when the fixed is maxed out">VIRG_TABLET_MAXED_VARIABLE</a>;
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(avail &gt; <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a>, <span class="stringliteral">&quot;already at max, size_t underflow&quot;</span>)

        <span class="comment">// calculate how many new rows we can fit into that space</span>
        unsigned pr = avail / stride;

        <span class="comment">// add the rows</span>
        <a class="code" href="group__tablet.html#gad8a1519a69a43f924a94cec0a691392c" title="Add fixed-size rows to a tablet.">virg_tablet_addrows</a>(v, tab, pr - tab-&gt;rows);

        return <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="gad8a1519a69a43f924a94cec0a691392c"></a><!-- doxytag: member="addrows.c::virg_tablet_addrows" ref="gad8a1519a69a43f924a94cec0a691392c" args="(virginian *v, virg_tablet_meta *tab, unsigned rows)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_tablet_addrows </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> *&#160;</td>
          <td class="paramname"><em>tab</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>rows</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add fixed-size rows to a tablet. </p>
<p>This function handles adding a certain number of fixed-size row spaces to a tablet. It is guaranteed to add this amount of row space because it will continue adding tablets onto the tail of the current tablet until this goal is achieved. Note that the number of possible rows in a tablet must be a multiple of 16, and this function performs rounding to ensure that this is the case. This function is called by virg_tablet_insert() to add a new block of possible rows whenever the insert operation does not have any space to add a single new row.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">tab</td><td>Pointer to tablet in which the rows are added </td></tr>
    <tr><td class="paramname">id</td><td>Number of rows to add to tablet and subsequent tablets </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="addrows_8c_source.html#l00022">22</a> of file <a class="el" href="addrows_8c_source.html">addrows.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="comment">// TODO add resizing of variable block</span>
        <span class="keywordtype">unsigned</span> i;
        <span class="keywordtype">size_t</span> row_stride = tab-&gt;<a class="code" href="structvirg__tablet__meta.html#ae0d98c019521326affbcab24362a7c71" title="stride of fixed-size columns, including key and key pointer">row_stride</a>;

        <span class="keywordtype">unsigned</span> max_new_rows = (<a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a> - tab-&gt;<a class="code" href="structvirg__tablet__meta.html#ad65a3feff0d4d970d956214bc658a962" title="total size of this tablet">size</a>) / row_stride;

        <span class="comment">// round the maximum number of new rows down to a multiple of 16</span>
        max_new_rows &amp;= 0xFFFFFFF0;

        <span class="comment">// round the number of rows to be added up to a multiple of 16</span>
        rows = (rows - 1 + 16) &amp; 0xFFFFFFF0;
        <span class="keywordtype">unsigned</span> new_rows = <a class="code" href="virginian_8h.html#ac8c9f6fbeb9d60a07ec61b3f3430d48a" title="convenience macro to return the min of the two inputs">VIRG_MIN</a>(max_new_rows, rows);

        <a class="code" href="virginian_8h.html#a53c3d8f6ba6373cf9095d58d3ba4f7e1">VIRG_DEBUG_CHECK</a>(tab-&gt;<a class="code" href="structvirg__tablet__meta.html#ad65a3feff0d4d970d956214bc658a962" title="total size of this tablet">size</a> + row_stride * new_rows &gt; <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a>, <span class="stringliteral">&quot;new rows over tablet size&quot;</span>)

        size_t new_fixed_block = tab-&gt;fixed_block +
                new_rows * (tab-&gt;key_stride + tab-&gt;key_pointer_stride);

        <span class="comment">// if we can fit more rows into this tablet</span>
        if(new_rows != 0) {
                <a class="code" href="group__tablet.html#gaaa3df8caa444c2afb156e0b4673fc492" title="Grows the fixed_block of a tablet by moving the variable block back.">virg_tablet_growfixed</a>(tab, row_stride * new_rows);
                tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a785691ca2a53ec6a5d5c34bca74c882d" title="fixed-size rows that can be in this tablet without reorganizing columns">possible_rows</a> += new_rows;

                <span class="comment">// generate new fixed column offsets</span>
                <span class="keywordtype">size_t</span> new_offsets[tab-&gt;<a class="code" href="structvirg__tablet__meta.html#aa3595a9a97105ce081422911c30c0269" title="number of fixed-size columns">fixed_columns</a>];
                new_offsets[0] = 0;

                <span class="keywordflow">for</span>(i = 1; i &lt; tab-&gt;<a class="code" href="structvirg__tablet__meta.html#aa3595a9a97105ce081422911c30c0269" title="number of fixed-size columns">fixed_columns</a>; i++)
                        new_offsets[i] = new_offsets[i-1] +
                                tab-&gt;<a class="code" href="structvirg__tablet__meta.html#af8affe76f89dd02d3f09a052982ae428" title="size in bytes of each of the fixed-size columns">fixed_stride</a>[i-1] * tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a785691ca2a53ec6a5d5c34bca74c882d" title="fixed-size rows that can be in this tablet without reorganizing columns">possible_rows</a>;

                <span class="comment">// move each column individually</span>
                <span class="keywordflow">for</span>(i = tab-&gt;<a class="code" href="structvirg__tablet__meta.html#aa3595a9a97105ce081422911c30c0269" title="number of fixed-size columns">fixed_columns</a>-1; i &lt; tab-&gt;fixed_columns; i--) {
                        <a class="code" href="virginian_8h.html#a53c3d8f6ba6373cf9095d58d3ba4f7e1">VIRG_DEBUG_CHECK</a>((new_fixed_block + new_offsets[i] + tab-&gt;<a class="code" href="structvirg__tablet__meta.html#ac68b11acc7d264e16025e3017a3c671a" title="number of rows stored in this tablet">rows</a> * tab-&gt;<a class="code" href="structvirg__tablet__meta.html#af8affe76f89dd02d3f09a052982ae428" title="size in bytes of each of the fixed-size columns">fixed_stride</a>[i]) &gt; <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a>, <span class="stringliteral">&quot;memmove exceeds tablet limit&quot;</span>)
                        memmove((<span class="keywordtype">char</span>*)tab + new_fixed_block + new_offsets[i],
                                (<span class="keywordtype">char</span>*)tab + tab-&gt;fixed_block + tab-&gt;fixed_offset[i],
                                tab-&gt;rows * tab-&gt;fixed_stride[i]);
                }

                <span class="comment">// copy new offsets</span>
                tab-&gt;fixed_block = new_fixed_block;
                for(i = 0; i &lt; tab-&gt;fixed_columns; i++)
                        tab-&gt;fixed_offset[i] = new_offsets[i];

                <span class="comment">// move key pointer block</span>
                <span class="keywordtype">size_t</span> new_key_pointers_block = tab-&gt;key_block + tab-&gt;key_stride * tab-&gt;possible_rows;
                memmove((<span class="keywordtype">char</span>*)tab + new_key_pointers_block,
                        (<span class="keywordtype">char</span>*)tab + tab-&gt;key_pointers_block,
                        tab-&gt;rows * tab-&gt;key_pointer_stride);
                tab-&gt;key_pointers_block = new_key_pointers_block;
        }

        <span class="comment">// if we can&#39;t fit all of the new rows onto the current tablet</span>
        if(max_new_rows &lt;= rows) {
                <a class="code" href="group__tablet.html#gabd69b51cf1469c95d1574b1d53935391" title="Add a lock to a tablet.">virg_tablet_lock</a>(v, tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a8287e9d36017a86bc3657de07cfbb47e" title="tablet id">id</a>);

                tab-&gt;<a class="code" href="structvirg__tablet__meta.html#ad65a3feff0d4d970d956214bc658a962" title="total size of this tablet">size</a> = <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a>; <span class="comment">// max out tablet size</span>
                <span class="keywordtype">unsigned</span> rows_left = rows - new_rows;
                <span class="keywordtype">unsigned</span> max_tablet_rows = (<a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a> - 
                        <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a>) - <a class="code" href="virginian_8h.html#ac66ec69a5db41b1db69335bea31cc639" title="initial size of the fixed block">VIRG_TABLET_INITIAL_FIXED</a>) / row_stride;

                <a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a> *node = tab;
                <a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a> *tail;

                <span class="comment">// add tablets until we can fit in all the rows we need</span>
                <span class="keywordflow">while</span>(rows_left &gt; 0) {
                        <span class="keywordtype">unsigned</span> r = <a class="code" href="virginian_8h.html#ac8c9f6fbeb9d60a07ec61b3f3430d48a" title="convenience macro to return the min of the two inputs">VIRG_MIN</a>(rows_left, max_tablet_rows);
                        <a class="code" href="group__tablet.html#ga3798b847b682e36ff95826f3aea15e70" title="Initialize a result tablet reader.">virg_tablet_addtail</a>(v, node, &amp;tail, r);
                        <span class="comment">//virg_print_slots(v);</span>
                        rows_left -= r;
                        node = tail;
                }

                <span class="comment">// if this is a data tablet, change the table to reflect the tablets</span>
                <span class="comment">// that have been added</span>
                <span class="keywordflow">if</span>(tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a1059257e09da533e228e62e881a2c813" title="boolean indicating whether or not this tablet is part of a table">in_table</a>) {
                        v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#ac8560755766ec57cc30bd45c972242bd" title="maps table id to the id of its last tablet">last_tablet</a>[tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a67c202be23e22fae83de9639b3b80110" title="id of the table that this tablet is a part of, if applicable">table_id</a>] = tail-&gt;<a class="code" href="structvirg__tablet__meta.html#a8287e9d36017a86bc3657de07cfbb47e" title="tablet id">id</a>;
                        v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#acd5ea5ce0d1eaf0910665ba8db39161c" title="number of tablets for each table">table_tablets</a>[tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a67c202be23e22fae83de9639b3b80110" title="id of the table that this tablet is a part of, if applicable">table_id</a>]++;
                }
                <a class="code" href="group__tablet.html#ga8e6a3f46a4efe9347c8202acc032db69" title="Release a lock to a tablet.">virg_tablet_unlock</a>(v, node-&gt;<a class="code" href="structvirg__tablet__meta.html#a8287e9d36017a86bc3657de07cfbb47e" title="tablet id">id</a>);
        }

        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga3798b847b682e36ff95826f3aea15e70"></a><!-- doxytag: member="addtail.c::virg_tablet_addtail" ref="ga3798b847b682e36ff95826f3aea15e70" args="(virginian *v, virg_tablet_meta *head, virg_tablet_meta **tail, unsigned possible_rows)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_tablet_addtail </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> *&#160;</td>
          <td class="paramname"><em>head</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> **&#160;</td>
          <td class="paramname"><em>tail</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>possible_rows</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Initialize a result tablet reader. </p>
<p>This function adds a new tail tablet to the tablet passed in and updates the tail pointer to reflect this addition. The tail tablet is constructed by copying all of the meta information then changing only what needs to be changed.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">head</td><td>Pointer to the tablet receiving the new tail </td></tr>
    <tr><td class="paramname">tail</td><td>Pointer to the pointer used to manage the tail node of the tablet string </td></tr>
    <tr><td class="paramname">possible_rows</td><td>Set the initial possible rows of the tablet </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="addtail_8c_source.html#l00020">20</a> of file <a class="el" href="addtail_8c_source.html">addtail.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a> *<a class="code" href="vm__gpu_8cu.html#a98365893b0ed61f342c55a901d47b738">meta</a>;

        <span class="comment">// assign tablet id</span>
        <span class="keywordtype">int</span> tablet_id = v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a6657ccb6b05ec1b98ff5d5e868f4e1bc" title="used to assign unique ids to each data and result tablet">tablet_id_counter</a>++;

        <span class="comment">// allocate a tablet slot using id</span>
        <a class="code" href="group__database.html#gaa6d6a3af446d22e836e0acc488db0348" title="Allocate a tablet slot and return a pointer to it.">virg_db_alloc</a>(v, &amp;meta, tablet_id);

        <span class="comment">// first just copy over all meta information</span>
        memcpy(meta, head, <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a>));
        head-&gt;<a class="code" href="structvirg__tablet__meta.html#aba80db72f84483fc51af9e39fe5c3590" title="boolean indicating whether this is the last tablet in the tablet string">last_tablet</a> = 0;
        head-&gt;<a class="code" href="structvirg__tablet__meta.html#a08bff8a2b2cbe7abbbdb0e85a530b065" title="id of the next tablet in the tablet string">next</a> = tablet_id;

        <a class="code" href="group__tablet.html#ga8e6a3f46a4efe9347c8202acc032db69" title="Release a lock to a tablet.">virg_tablet_unlock</a>(v, head-&gt;<a class="code" href="structvirg__tablet__meta.html#a8287e9d36017a86bc3657de07cfbb47e" title="tablet id">id</a>);

        <span class="comment">// then change meta information as appropriate</span>
        tail[0] = <a class="code" href="vm__gpu_8cu.html#a98365893b0ed61f342c55a901d47b738">meta</a>;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#ac68b11acc7d264e16025e3017a3c671a" title="number of rows stored in this tablet">rows</a> = 0;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a8287e9d36017a86bc3657de07cfbb47e" title="tablet id">id</a> = tablet_id;

        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a9b5a18ab0b852cdcb0608d0113ce25f1" title="relative ptr to the beginning of the key pointer column">key_pointers_block</a> = meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a381166a5323a226a9cf70a527e9f7876" title="relative ptr to the beginning of the key column">key_block</a> +
                meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a16e649bf6f3217270c3fe84fe4d00114" title="stride of the variable type of the key column">key_stride</a> * possible_rows;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a7b2629d1c97658c8b7a89dff95a1d52b" title="relative ptr to the beginning of the fixed-column area">fixed_block</a> = meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a9b5a18ab0b852cdcb0608d0113ce25f1" title="relative ptr to the beginning of the key pointer column">key_pointers_block</a> +
                meta-&gt;<a class="code" href="structvirg__tablet__meta.html#aa7a96e05a26f25298bece2686c758200" title="stride of the key pointer variable type">key_pointer_stride</a> * possible_rows;

        <span class="keywordtype">unsigned</span> i;
        <span class="keywordflow">for</span>(i = 1; i &lt; meta-&gt;<a class="code" href="structvirg__tablet__meta.html#aa3595a9a97105ce081422911c30c0269" title="number of fixed-size columns">fixed_columns</a>; i++)
                meta-&gt;<a class="code" href="structvirg__tablet__meta.html#af46cdc848ccee989cf764abb07a9f29a" title="relative pointer from fixed_block indicating the beginning of the column">fixed_offset</a>[i] = meta-&gt;<a class="code" href="structvirg__tablet__meta.html#af46cdc848ccee989cf764abb07a9f29a" title="relative pointer from fixed_block indicating the beginning of the column">fixed_offset</a>[i-1] + meta-&gt;<a class="code" href="structvirg__tablet__meta.html#af8affe76f89dd02d3f09a052982ae428" title="size in bytes of each of the fixed-size columns">fixed_stride</a>[i-1] * possible_rows;

        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a> = meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a381166a5323a226a9cf70a527e9f7876" title="relative ptr to the beginning of the key column">key_block</a> + meta-&gt;<a class="code" href="structvirg__tablet__meta.html#ae0d98c019521326affbcab24362a7c71" title="stride of fixed-size columns, including key and key pointer">row_stride</a> * possible_rows;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#ad65a3feff0d4d970d956214bc658a962" title="total size of this tablet">size</a> = meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a> + <a class="code" href="virginian_8h.html#ad68fe01cd6f7a13b22e9e1741abcca81" title="initial size of the variable block">VIRG_TABLET_INITIAL_VARIABLE</a>;

        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a5bd107899dc507b45e96fd2c020aa533" title="pointer to the disk info struct associated with this tablet">info</a> = NULL;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a785691ca2a53ec6a5d5c34bca74c882d" title="fixed-size rows that can be in this tablet without reorganizing columns">possible_rows</a> = possible_rows;

        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga63806dc508073da387d045837f0d7e9d"></a><!-- doxytag: member="check.c::virg_tablet_check" ref="ga63806dc508073da387d045837f0d7e9d" args="(virg_tablet_meta *t)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_tablet_check </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> *&#160;</td>
          <td class="paramname"><em>t</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Ensure that the tablet is internally consistent and conforms to expectation. </p>
<p>This is a debugging function used to check that the tablet has not been corrupted, returning VIRG_SUCCESS if all tests are passed. This checks that the key block, key pointers block, columns, and variable block are all where they are expected to be and aligned given the meta information about columns and key and column widths.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">t</td><td>Pointer to the tablet to be checked </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="check_8c_source.html#l00017">17</a> of file <a class="el" href="check_8c_source.html">check.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="keywordtype">unsigned</span> pr = t-&gt;<a class="code" href="structvirg__tablet__meta.html#a785691ca2a53ec6a5d5c34bca74c882d" title="fixed-size rows that can be in this tablet without reorganizing columns">possible_rows</a>;
        <span class="keywordtype">unsigned</span> i;

        <span class="comment">// key block starts at the end of the meta block</span>
        assert(<span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a>) == t-&gt;<a class="code" href="structvirg__tablet__meta.html#a381166a5323a226a9cf70a527e9f7876" title="relative ptr to the beginning of the key column">key_block</a>);

        <span class="comment">// key pointers block starts at the end of the key block</span>
        assert(pr * t-&gt;<a class="code" href="structvirg__tablet__meta.html#a16e649bf6f3217270c3fe84fe4d00114" title="stride of the variable type of the key column">key_stride</a> + t-&gt;<a class="code" href="structvirg__tablet__meta.html#a381166a5323a226a9cf70a527e9f7876" title="relative ptr to the beginning of the key column">key_block</a> == t-&gt;<a class="code" href="structvirg__tablet__meta.html#a9b5a18ab0b852cdcb0608d0113ce25f1" title="relative ptr to the beginning of the key pointer column">key_pointers_block</a>);

        <span class="comment">// fixed block starts at the end of the key pointers block</span>
        assert(t-&gt;<a class="code" href="structvirg__tablet__meta.html#a7b2629d1c97658c8b7a89dff95a1d52b" title="relative ptr to the beginning of the fixed-column area">fixed_block</a> + pr * (t-&gt;<a class="code" href="structvirg__tablet__meta.html#ae0d98c019521326affbcab24362a7c71" title="stride of fixed-size columns, including key and key pointer">row_stride</a> - t-&gt;<a class="code" href="structvirg__tablet__meta.html#a16e649bf6f3217270c3fe84fe4d00114" title="stride of the variable type of the key column">key_stride</a> - t-&gt;<a class="code" href="structvirg__tablet__meta.html#aa7a96e05a26f25298bece2686c758200" title="stride of the key pointer variable type">key_pointer_stride</a>) == t-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a>);

        <span class="comment">// if there are columns in the tablet</span>
        <span class="keywordflow">if</span>(t-&gt;<a class="code" href="structvirg__tablet__meta.html#aa3595a9a97105ce081422911c30c0269" title="number of fixed-size columns">fixed_columns</a> &gt; 0) {
                <span class="comment">// the offset of the first column is always 0</span>
                assert(t-&gt;<a class="code" href="structvirg__tablet__meta.html#af46cdc848ccee989cf764abb07a9f29a" title="relative pointer from fixed_block indicating the beginning of the column">fixed_offset</a>[0] == 0);

                <span class="comment">// the offset of each column should be just after the last column&#39;s</span>
                <span class="comment">// block</span>
                <span class="keywordflow">for</span>(i = 1; i &lt; t-&gt;<a class="code" href="structvirg__tablet__meta.html#aa3595a9a97105ce081422911c30c0269" title="number of fixed-size columns">fixed_columns</a>; i++)
                        assert(t-&gt;<a class="code" href="structvirg__tablet__meta.html#af46cdc848ccee989cf764abb07a9f29a" title="relative pointer from fixed_block indicating the beginning of the column">fixed_offset</a>[i] == t-&gt;<a class="code" href="structvirg__tablet__meta.html#af46cdc848ccee989cf764abb07a9f29a" title="relative pointer from fixed_block indicating the beginning of the column">fixed_offset</a>[i - 1] +
                                pr * t-&gt;<a class="code" href="structvirg__tablet__meta.html#af8affe76f89dd02d3f09a052982ae428" title="size in bytes of each of the fixed-size columns">fixed_stride</a>[i - 1]);

                <span class="comment">// the variable block should be just after the last column&#39;s block</span>
                assert(t-&gt;<a class="code" href="structvirg__tablet__meta.html#a7b2629d1c97658c8b7a89dff95a1d52b" title="relative ptr to the beginning of the fixed-column area">fixed_block</a> + t-&gt;<a class="code" href="structvirg__tablet__meta.html#af46cdc848ccee989cf764abb07a9f29a" title="relative pointer from fixed_block indicating the beginning of the column">fixed_offset</a>[t-&gt;<a class="code" href="structvirg__tablet__meta.html#aa3595a9a97105ce081422911c30c0269" title="number of fixed-size columns">fixed_columns</a>-1] +
                        pr * t-&gt;<a class="code" href="structvirg__tablet__meta.html#af8affe76f89dd02d3f09a052982ae428" title="size in bytes of each of the fixed-size columns">fixed_stride</a>[t-&gt;<a class="code" href="structvirg__tablet__meta.html#aa3595a9a97105ce081422911c30c0269" title="number of fixed-size columns">fixed_columns</a>-1] == t-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a>);
        }
        <span class="comment">// otherwise the fixed block has a zero size</span>
        <span class="keywordflow">else</span>
                assert(t-&gt;<a class="code" href="structvirg__tablet__meta.html#a7b2629d1c97658c8b7a89dff95a1d52b" title="relative ptr to the beginning of the fixed-column area">fixed_block</a> == t-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a>);

        <span class="comment">// meta is 64-bit aligned</span>
        assert((t-&gt;<a class="code" href="structvirg__tablet__meta.html#a381166a5323a226a9cf70a527e9f7876" title="relative ptr to the beginning of the key column">key_block</a> &amp; 0xFFFFFFC0) == t-&gt;<a class="code" href="structvirg__tablet__meta.html#a381166a5323a226a9cf70a527e9f7876" title="relative ptr to the beginning of the key column">key_block</a>);

        <span class="comment">// possible rows is a multiple of 16</span>
        assert((t-&gt;<a class="code" href="structvirg__tablet__meta.html#a785691ca2a53ec6a5d5c34bca74c882d" title="fixed-size rows that can be in this tablet without reorganizing columns">possible_rows</a> &amp; 0xFFFFFFF0) == t-&gt;<a class="code" href="structvirg__tablet__meta.html#a785691ca2a53ec6a5d5c34bca74c882d" title="fixed-size rows that can be in this tablet without reorganizing columns">possible_rows</a>);

        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="gac81bdeda780fac6917c8942bec57a581"></a><!-- doxytag: member="create.c::virg_tablet_create" ref="gac81bdeda780fac6917c8942bec57a581" args="(virginian *v, int *id, virg_t key_type, unsigned table_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_tablet_create </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="virginian_8h.html#a5edb977d9e195d5df43f1757f311292b">virg_t</a>&#160;</td>
          <td class="paramname"><em>key_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>table_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create an empty tablet for a new table. </p>
<p>This function creates a brand new empty tablet with all of the default tablet settings. This is called only by <a class="el" href="group__table.html#gabd464f256a1d2645488e015f4a6da1b3" title="Create a new table.">virg_table_create()</a> to produce the first empty tablet for a new table, most new tablets are created with <a class="el" href="group__tablet.html#ga3798b847b682e36ff95826f3aea15e70" title="Initialize a result tablet reader.">virg_tablet_addtail()</a>. Columns are added later to the tablet with <a class="el" href="group__tablet.html#gad8e8dfe554d09257dbccd44b7bc35f2c" title="Add a column to a tablet.">virg_tablet_addcolumn()</a>.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">key_type</td><td>Type of the primary key of the tablet </td></tr>
    <tr><td class="paramname">table_id</td><td>ID of the table to which this tablet will belong </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="tablet_2create_8c_source.html#l00019">19</a> of file <a class="el" href="tablet_2create_8c_source.html">create.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a> *<a class="code" href="vm__gpu_8cu.html#a98365893b0ed61f342c55a901d47b738">meta</a>;

        <span class="comment">// assign tablet id</span>
        <span class="keywordtype">int</span> tablet_id = v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>.<a class="code" href="structvirg__db.html#a6657ccb6b05ec1b98ff5d5e868f4e1bc" title="used to assign unique ids to each data and result tablet">tablet_id_counter</a>++;

        <span class="comment">// allocate tablet slot with this id</span>
        <a class="code" href="group__database.html#gaa6d6a3af446d22e836e0acc488db0348" title="Allocate a tablet slot and return a pointer to it.">virg_db_alloc</a>(v, &amp;meta, tablet_id);

<span class="preprocessor">#ifdef VIRG_DEBUG</span>
<span class="preprocessor"></span>        <span class="comment">// 0 out meta block for valgrind</span>
        memset(meta, 0, <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a>));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
        <span class="comment">// set tablet meta information</span>
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#ac68b11acc7d264e16025e3017a3c671a" title="number of rows stored in this tablet">rows</a> = 0;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a21626738f2e3e000d376a912558130fa" title="variable type of the key column">key_type</a> = key_type;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a16e649bf6f3217270c3fe84fe4d00114" title="stride of the variable type of the key column">key_stride</a> = virg_sizeof(key_type);
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#aa7a96e05a26f25298bece2686c758200" title="stride of the key pointer variable type">key_pointer_stride</a> = <span class="keyword">sizeof</span>(size_t);
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#ae0d98c019521326affbcab24362a7c71" title="stride of fixed-size columns, including key and key pointer">row_stride</a> = meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a16e649bf6f3217270c3fe84fe4d00114" title="stride of the variable type of the key column">key_stride</a> + meta-&gt;<a class="code" href="structvirg__tablet__meta.html#aa7a96e05a26f25298bece2686c758200" title="stride of the key pointer variable type">key_pointer_stride</a>;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#aba80db72f84483fc51af9e39fe5c3590" title="boolean indicating whether this is the last tablet in the tablet string">last_tablet</a> = 1;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a8287e9d36017a86bc3657de07cfbb47e" title="tablet id">id</a> = tablet_id;
        <span class="keywordtype">id</span>[0] = tablet_id;
        <span class="keywordflow">if</span>(table_id &gt; <a class="code" href="virginian_8h.html#a6b400ca21647bb81159b1c459ef053e2" title="maximum tables supported">VIRG_MAX_TABLES</a>) {
                meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a1059257e09da533e228e62e881a2c813" title="boolean indicating whether or not this tablet is part of a table">in_table</a> = 0;
                meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a67c202be23e22fae83de9639b3b80110" title="id of the table that this tablet is a part of, if applicable">table_id</a> = 0;
        }
        <span class="keywordflow">else</span> {
                meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a1059257e09da533e228e62e881a2c813" title="boolean indicating whether or not this tablet is part of a table">in_table</a> = 1;
                meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a67c202be23e22fae83de9639b3b80110" title="id of the table that this tablet is a part of, if applicable">table_id</a> = table_id;
        }

        <span class="comment">// set block sizes according to possible rows</span>
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a785691ca2a53ec6a5d5c34bca74c882d" title="fixed-size rows that can be in this tablet without reorganizing columns">possible_rows</a> = <a class="code" href="virginian_8h.html#a9f440281a17ca1c0adab888f861278b6" title="rows to allocate when a tablet is created">VIRG_TABLET_INITIAL_KEYS</a>;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a381166a5323a226a9cf70a527e9f7876" title="relative ptr to the beginning of the key column">key_block</a> = <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a>);
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a9b5a18ab0b852cdcb0608d0113ce25f1" title="relative ptr to the beginning of the key pointer column">key_pointers_block</a> = meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a381166a5323a226a9cf70a527e9f7876" title="relative ptr to the beginning of the key column">key_block</a> +
                meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a16e649bf6f3217270c3fe84fe4d00114" title="stride of the variable type of the key column">key_stride</a> * <a class="code" href="virginian_8h.html#a9f440281a17ca1c0adab888f861278b6" title="rows to allocate when a tablet is created">VIRG_TABLET_INITIAL_KEYS</a>;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a7b2629d1c97658c8b7a89dff95a1d52b" title="relative ptr to the beginning of the fixed-column area">fixed_block</a> = meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a9b5a18ab0b852cdcb0608d0113ce25f1" title="relative ptr to the beginning of the key pointer column">key_pointers_block</a> +
                meta-&gt;<a class="code" href="structvirg__tablet__meta.html#aa7a96e05a26f25298bece2686c758200" title="stride of the key pointer variable type">key_pointer_stride</a> * <a class="code" href="virginian_8h.html#a9f440281a17ca1c0adab888f861278b6" title="rows to allocate when a tablet is created">VIRG_TABLET_INITIAL_KEYS</a>;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a> = meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a7b2629d1c97658c8b7a89dff95a1d52b" title="relative ptr to the beginning of the fixed-column area">fixed_block</a> + <a class="code" href="virginian_8h.html#ac66ec69a5db41b1db69335bea31cc639" title="initial size of the fixed block">VIRG_TABLET_INITIAL_FIXED</a>;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#ad65a3feff0d4d970d956214bc658a962" title="total size of this tablet">size</a> = meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a> + <a class="code" href="virginian_8h.html#ad68fe01cd6f7a13b22e9e1741abcca81" title="initial size of the variable block">VIRG_TABLET_INITIAL_VARIABLE</a>;

<span class="preprocessor">#ifdef VIRG_DEBUG</span>
<span class="preprocessor"></span>        <span class="comment">// 0 out the rest of the tablet for valgrind</span>
        memset(meta + meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a381166a5323a226a9cf70a527e9f7876" title="relative ptr to the beginning of the key column">key_block</a>, 0, meta-&gt;<a class="code" href="structvirg__tablet__meta.html#ad65a3feff0d4d970d956214bc658a962" title="total size of this tablet">size</a> - <span class="keyword">sizeof</span>(<a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a>));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#a5bd107899dc507b45e96fd2c020aa533" title="pointer to the disk info struct associated with this tablet">info</a> = NULL;
        meta-&gt;<a class="code" href="structvirg__tablet__meta.html#aa3595a9a97105ce081422911c30c0269" title="number of fixed-size columns">fixed_columns</a> = 0;

        <a class="code" href="group__tablet.html#ga8e6a3f46a4efe9347c8202acc032db69" title="Release a lock to a tablet.">virg_tablet_unlock</a>(v, tablet_id);

        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="gaaa3df8caa444c2afb156e0b4673fc492"></a><!-- doxytag: member="growfixed.c::virg_tablet_growfixed" ref="gaaa3df8caa444c2afb156e0b4673fc492" args="(virg_tablet_meta *tab, size_t size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_tablet_growfixed </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirg__tablet__meta.html">virg_tablet_meta</a> *&#160;</td>
          <td class="paramname"><em>tab</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Grows the fixed_block of a tablet by moving the variable block back. </p>
<p>Expands the fixed-size block of the tablet by moving the variable block back farther. This is a convenience function for other tablet functions, and leaves the tablet inconsistent because no virg_tablet_meta.possible_row or column information is edited, so it should be followed up with these changes to the tablet as well. Note that if the variable size block has a size of zero, this is very easy, as we just move its location back in the meta information. If not, however, we must perform a safe memory copy to transfer its contents farther back in the tablet.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">tab</td><td>Pointer to the tablet to be changed </td></tr>
    <tr><td class="paramname">size</td><td>Additional size to be added to the fixed block </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="growfixed_8c_source.html#l00021">21</a> of file <a class="el" href="growfixed_8c_source.html">growfixed.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="comment">// make sure you can add that much to the tablet</span>
        <a class="code" href="virginian_8h.html#a5199c848f6c06c5aabdc6546774d4f0d" title="print an error and return failure if the condition is true">VIRG_CHECK</a>(tab-&gt;<a class="code" href="structvirg__tablet__meta.html#ad65a3feff0d4d970d956214bc658a962" title="total size of this tablet">size</a> + size &gt; <a class="code" href="virginian_8h.html#a2ac1573feba851890134cec421e2e763" title="size of tablets, must be equal for the db file and the database">VIRG_TABLET_SIZE</a>, <span class="stringliteral">&quot;Too big to grow, the tablet must be split&quot;</span>);

        <span class="comment">// if the variable block has a zero size, we just move it back and return</span>
        <span class="comment">// otherwise we have to copy its contents</span>
        <span class="keywordflow">if</span>(tab-&gt;<a class="code" href="structvirg__tablet__meta.html#ad65a3feff0d4d970d956214bc658a962" title="total size of this tablet">size</a> == tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a>) {
                tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a> += size;
                tab-&gt;<a class="code" href="structvirg__tablet__meta.html#ad65a3feff0d4d970d956214bc658a962" title="total size of this tablet">size</a> += size;
                <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
        }

        <span class="keywordtype">size_t</span> new_variable = tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a> + size;
        <span class="keywordtype">size_t</span> variable_size = tab-&gt;<a class="code" href="structvirg__tablet__meta.html#ad65a3feff0d4d970d956214bc658a962" title="total size of this tablet">size</a> - tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a>;

        <span class="keywordtype">char</span> *dest = (<span class="keywordtype">char</span>*)tab + new_variable;
        <span class="keywordtype">char</span> *src = (<span class="keywordtype">char</span>*)tab + tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a>;

        <span class="comment">// move variable-sized information</span>
        memmove(dest, src, variable_size);

        tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a3ec258f17124528e236512d3b30b74be" title="relative ptr to the beginning of the variable-sized data area">variable_block</a> = new_variable;
        tab-&gt;<a class="code" href="structvirg__tablet__meta.html#ad65a3feff0d4d970d956214bc658a962" title="total size of this tablet">size</a> = new_variable + variable_size;

        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="gabd69b51cf1469c95d1574b1d53935391"></a><!-- doxytag: member="lock.c::virg_tablet_lock" ref="gabd69b51cf1469c95d1574b1d53935391" args="(virginian *v, unsigned tablet_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_tablet_lock </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>tablet_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add a lock to a tablet. </p>
<p>Add a lock on a certain tablet to ensure that it remains in that tablet slot. Locks accumulate; all slots start with a status of 0, which is raised to 1 when a tablet is loaded into it. A lock increments this number, so a tablet with a status of 2 or above can not be removed from that slot, even when the database is closed. Thus, all locks held on a tablet must be released before closing the tablet's database. If the tablet cannot be found to be locked, then return VIRG_FAIL.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">id</td><td>ID of the tablet to be locked </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="lock_8c_source.html#l00020">20</a> of file <a class="el" href="lock_8c_source.html">lock.c</a>.</p>
<div class="fragment"><pre class="fragment">{
<span class="preprocessor">#ifdef VIRG_DEBUG_SLOTS</span>
<span class="preprocessor"></span>        fprintf(stderr, <span class="stringliteral">&quot;trying to lock %i\n&quot;</span>, tablet_id);
        virg_print_slots(v);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
        <span class="comment">// tablet slot lock</span>
        pthread_mutex_lock(&amp;v-&gt;<a class="code" href="structvirginian.html#a26ed4b0163e1b8a4ac20898715519588" title="mutex for multi-core manipulation of the tablet slots">slot_lock</a>);

        <span class="comment">// look for tablet to lock</span>
        <span class="keywordtype">unsigned</span> i;
        <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a>; i++)
                <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[i] &gt; 0 &amp;&amp; v-&gt;<a class="code" href="structvirginian.html#acf3ed38504bbb207ffa500d1508cad97" title="id of the tablet in each slot, valid only if status is above 0">tablet_slot_ids</a>[i] == tablet_id)
                        <span class="keywordflow">break</span>;

        <span class="comment">// check to make sure the tablet was found</span>
<span class="preprocessor">#ifdef VIRG_DEBUG</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span>(i == VIRG_MEM_TABLETS) {
                virg_print_slots(v);
                fprintf(stderr, <span class="stringliteral">&quot;looking for %u\n&quot;</span>, tablet_id);
        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        <a class="code" href="virginian_8h.html#a53c3d8f6ba6373cf9095d58d3ba4f7e1">VIRG_DEBUG_CHECK</a>(i == VIRG_MEM_TABLETS, <span class="stringliteral">&quot;Couldn&#39;t find tablet to lock&quot;</span>);

        <span class="comment">// increase the number of read locks</span>
        v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[i]++;

        <span class="comment">// unlock tablet slots</span>
        pthread_mutex_unlock(&amp;v-&gt;<a class="code" href="structvirginian.html#a26ed4b0163e1b8a4ac20898715519588" title="mutex for multi-core manipulation of the tablet slots">slot_lock</a>);

        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga00875121a2be660a42c7633b13d0e27c"></a><!-- doxytag: member="remove.c::virg_tablet_remove" ref="ga00875121a2be660a42c7633b13d0e27c" args="(virginian *v, unsigned id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_tablet_remove </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Deletes a tablet from memory and disk. </p>
<p>Sets the in-memory tablet slot and disk slot of a tablet to unused, removing that tablet. Note that this function is used for removing result tablets and does not change the variables of other tablets in the tablet string, so it will leave that string inconsistent.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">id</td><td>ID of the tablet to be removed </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="remove_8c_source.html#l00017">17</a> of file <a class="el" href="remove_8c_source.html">remove.c</a>.</p>
<div class="fragment"><pre class="fragment">{
        <span class="keywordtype">unsigned</span> i;

<span class="preprocessor">#ifdef VIRG_DEBUG_SLOTS</span>
<span class="preprocessor"></span>        fprintf(stderr, <span class="stringliteral">&quot;trying to remove %i\n&quot;</span>, <span class="keywordtype">id</span>);
        virg_print_slots(v);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
        <span class="comment">// find tablet with id</span>
        <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a>; i++) {
                <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[i] != 0 &amp;&amp; v-&gt;<a class="code" href="structvirginian.html#acf3ed38504bbb207ffa500d1508cad97" title="id of the tablet in each slot, valid only if status is above 0">tablet_slot_ids</a>[i] == <span class="keywordtype">id</span>) {
                        <a class="code" href="virginian_8h.html#a53c3d8f6ba6373cf9095d58d3ba4f7e1">VIRG_DEBUG_CHECK</a>(v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[i] &gt; 1, <span class="stringliteral">&quot;Trying to remove locked tablet&quot;</span>);

                        <span class="comment">// set in-memory tablet slot to unused</span>
                        <a class="code" href="structvirg__tablet__meta.html" title="Tablet meta information.">virg_tablet_meta</a> *tab = v-&gt;<a class="code" href="structvirginian.html#a5b2712b05652c6c884e7550c15a86428" title="pointer to each main-memory tablet slot">tablet_slots</a>[i];
                        <a class="code" href="structvirg__tablet__info.html" title="Information associated with a tablet on disk.">virg_tablet_info</a> *info = tab-&gt;<a class="code" href="structvirg__tablet__meta.html#a5bd107899dc507b45e96fd2c020aa533" title="pointer to the disk info struct associated with this tablet">info</a>;
                        <span class="keywordflow">if</span>(info != NULL)
                                info-&gt;<a class="code" href="structvirg__tablet__info.html#a5d254b530b1e2bf333f614c96afefe6f" title="note whether or not there is a tablet stored in this disk slot">used</a> = 0;

                        v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[i] = 0;
                        v-&gt;<a class="code" href="structvirginian.html#ab4ab09cb712e32031e114b442c0c8157" title="number of tablet slots which are unused">tablet_slots_taken</a>--;

                        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
                }
        }

        <span class="comment">// look for the tablet on disk and set its spot to unused if found</span>
        <a class="code" href="structvirg__db.html" title="State of the currently open database.">virg_db</a> *db = &amp;v-&gt;<a class="code" href="structvirginian.html#a4475e39a0380efc27a50823d7fc11cb7" title="database file state">db</a>;
        <span class="keywordflow">for</span>(i = 0; i &lt; db-&gt;<a class="code" href="structvirg__db.html#a071548caca50ad0408ca5f81cd82d898" title="number of virg_tablet_info structs that have been allocated">alloced_tablets</a>; i++) {
                <span class="keywordflow">if</span>(db-&gt;<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#a5d254b530b1e2bf333f614c96afefe6f" title="note whether or not there is a tablet stored in this disk slot">used</a> == 1 &amp;&amp; db-&gt;<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#ac3d14971c28b9823b686ab0b848002b2" title="id of the tablet stored in this slot, valid only if used == 1">id</a> == <span class="keywordtype">id</span>) {
                        db-&gt;<a class="code" href="structvirg__db.html#a26636f8d326509af7c3faa1d41e76472" title="pointer to the block allocated to store virg_tablet_info structs">tablet_info</a>[i].<a class="code" href="structvirg__tablet__info.html#a5d254b530b1e2bf333f614c96afefe6f" title="note whether or not there is a tablet stored in this disk slot">used</a> = 0;
                        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
                }
        }

        fprintf(stderr, <span class="stringliteral">&quot;Could not find tablet to remove\n&quot;</span>);
        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ac21dbbc06d2c74731554f359edd10702" title="used to return a function failure">VIRG_FAIL</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ga8e6a3f46a4efe9347c8202acc032db69"></a><!-- doxytag: member="lock.c::virg_tablet_unlock" ref="ga8e6a3f46a4efe9347c8202acc032db69" args="(virginian *v, unsigned tablet_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int virg_tablet_unlock </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structvirginian.html">virginian</a> *&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>tablet_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Release a lock to a tablet. </p>
<p>Releases a lock on a tablet. If the tablet cannot be found, or if it is not locked when the lock attempts to release, then VIRG_FAIL is returned.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">v</td><td>Pointer to the state struct of the database system </td></tr>
    <tr><td class="paramname">id</td><td>ID of the tablet to be unlocked </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>VIRG_SUCCESS or VIRG_FAIL depending on errors during the function call </dd></dl>

<p>Definition at line <a class="el" href="lock_8c_source.html#l00066">66</a> of file <a class="el" href="lock_8c_source.html">lock.c</a>.</p>
<div class="fragment"><pre class="fragment">{
<span class="preprocessor">#ifdef VIRG_DEBUG_SLOTS</span>
<span class="preprocessor"></span>        fprintf(stderr, <span class="stringliteral">&quot;trying to unlock %i\n&quot;</span>, tablet_id);
        virg_print_slots(v);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
        <span class="comment">// tablet slot lock</span>
        pthread_mutex_lock(&amp;v-&gt;<a class="code" href="structvirginian.html#a26ed4b0163e1b8a4ac20898715519588" title="mutex for multi-core manipulation of the tablet slots">slot_lock</a>);
        
        <span class="comment">// look for tablet, which must have a locked status</span>
        <span class="keywordtype">unsigned</span> i;
        <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="virginian_8h.html#a9c6e6ed866369d7cc0288fafd223a87b" title="tablet slots to allocate in memory">VIRG_MEM_TABLETS</a>; i++)
                <span class="keywordflow">if</span>(v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[i] &gt; 1 &amp;&amp; v-&gt;<a class="code" href="structvirginian.html#acf3ed38504bbb207ffa500d1508cad97" title="id of the tablet in each slot, valid only if status is above 0">tablet_slot_ids</a>[i] == tablet_id)
                        <span class="keywordflow">break</span>;

        <span class="comment">// check to make sure the tablet was found</span>
<span class="preprocessor">#ifdef VIRG_DEBUG</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span>(i == VIRG_MEM_TABLETS) {
                virg_print_slots(v);
                fprintf(stderr, <span class="stringliteral">&quot;looking for %u\n&quot;</span>, tablet_id);
        }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        <a class="code" href="virginian_8h.html#a53c3d8f6ba6373cf9095d58d3ba4f7e1">VIRG_DEBUG_CHECK</a>(i == VIRG_MEM_TABLETS, <span class="stringliteral">&quot;Couldn&#39;t find tablet to unlock&quot;</span>);

        <span class="comment">// decrease the number of read locks</span>
        v-&gt;<a class="code" href="structvirginian.html#ae6776e19e678dca8d07646de4ad8ae8c" title="use status of the tablet slot, 0 for unused, 1 for used, &gt;1 for each lock">tablet_slot_status</a>[i]--;

        <span class="comment">// unlock tablet slots</span>
        pthread_mutex_unlock(&amp;v-&gt;<a class="code" href="structvirginian.html#a26ed4b0163e1b8a4ac20898715519588" title="mutex for multi-core manipulation of the tablet slots">slot_lock</a>);

        <span class="keywordflow">return</span> <a class="code" href="virginian_8h.html#ae39e133b80ee1958313531a94cb517d2" title="used to return a function success">VIRG_SUCCESS</a>;
}
</pre></div>
</div>
</div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Wed Feb 15 2012 01:21:46 for Virginian by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
